"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[262],{59370:function(e,t,l){l.r(t),l.d(t,{default:function(){return K}});var a=l(85893),s=l(67294),r=l(41118),n=l(16789),o=l(80837),i=l(79172),c=l(51610),d=l(48665),u=l(577),x=l(1375),h=e=>{let t=(0,s.useReducer)((e,t)=>({...e,...t}),{...e});return t},m=l(2453),f=l(41468),p=l(83454),v=e=>{let{queryAgentURL:t,channel:l,queryBody:a,initHistory:r=[]}=e,[n,o]=h({history:r}),{refreshDialogList:i,chatId:c,model:d}=(0,s.useContext)(f.p),u=new AbortController;(0,s.useEffect)(()=>{r&&r.length&&o({history:r})},[r]);let v=async(e,s)=>{if(!e)return;let r=[...n.history,{role:"human",context:e}],h=r.length;o({history:r});let f={conv_uid:c,...s,...a,user_input:e,channel:l};if(!(null==f?void 0:f.conv_uid)){m.ZP.error("conv_uid 不存在，请刷新后重试");return}try{await (0,x.L)("".concat(p.env.API_BASE_URL?p.env.API_BASE_URL:"").concat("/api"+t),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f),signal:u.signal,openWhenHidden:!0,async onopen(e){if(r.length<=1){var t;i();let e=new URLSearchParams(window.location.search);e.delete("initMessage"),null===(t=window.history)||void 0===t||t.replaceState(null,"","?".concat(e.toString()))}(!e.ok||e.headers.get("content-type")!==x.a)&&e.status>=400&&e.status<500&&429!==e.status&&e.status},onclose(){console.log("onclose")},onerror(e){throw console.log("onerror"),Error(e)},onmessage:e=>{var t,l,a;if(e.data=null===(t=e.data)||void 0===t?void 0:t.replaceAll("\\n","\n"),"[DONE]"===e.data);else if(null===(l=e.data)||void 0===l?void 0:l.startsWith("[ERROR]"))o({history:[...r,{role:"view",context:null===(a=e.data)||void 0===a?void 0:a.replace("[ERROR]","")}]});else{let t=[...r];e.data&&((null==t?void 0:t[h])?t[h].context="".concat(e.data):t.push({role:"view",context:e.data,model_name:d}),o({history:t}))}}})}catch(e){console.log(e),o({history:[...r,{role:"view",context:"Sorry, We meet some error, please try agin later."}]})}};return{handleChatSubmit:v,history:n.history}},g=l(24339),y=l(14986),w=l(30322),j=l(75913),b=l(14553),_=l(48699),Z=l(13245),N=l(43458),k=l(47556),S=l(87536),C=l(39332),E=l(96486),R=l.n(E),O=l(99513),A=l(2166),P=l(50228),D=l(87547),L=l(35576),M=l(56986),U=l(93179),q=l(81799),F=l(94184),H=l.n(F);let I={overrides:{code:e=>{let{children:t,className:l}=e;return(0,a.jsx)(U.Z,{language:"javascript",style:M.Z,children:t})},img:{props:{className:"my-2 !max-h-none"}},table:{props:{className:"my-2 border-collapse border border-slate-400 dark:border-slate-500 bg-white dark:bg-slate-800 text-sm shadow-sm"}},thead:{props:{className:"bg-slate-50 dark:bg-slate-700"}},th:{props:{className:"border border-slate-300 dark:border-slate-600 font-semibold !p-2 text-slate-900 dark:text-slate-200 !text-left"}},td:{props:{className:"border border-slate-300 dark:border-slate-700 !p-2 text-slate-500 dark:text-slate-400 !text-left"}}},wrapper:s.Fragment,namedCodesToUnicode:{amp:"&",apos:"'",gt:">",lt:"<",nbsp:"\xa0",quot:"“"}};var J=function(e){let{content:t,isChartChat:l,onLinkClick:r}=e,{context:n,model_name:o,role:i}=t,{scene:c}=(0,s.useContext)(f.p),d="view"===i;return(0,a.jsxs)("div",{className:H()("overflow-x-auto w-full flex px-2 sm:px-4 py-2 sm:py-6 rounded-xl",{"bg-slate-100 dark:bg-[#353539]":d,"lg:w-full xl:w-full pl-0":["chat_with_db_execute","chat_dashboard"].includes(c)}),children:[(0,a.jsx)("div",{className:"mr-2 flex flex-shrink-0 items-center justify-center h-7 w-7 rounded-full text-lg sm:mr-4",children:d?(0,q.A)(o)||(0,a.jsx)(P.Z,{}):(0,a.jsx)(D.Z,{})}),(0,a.jsxs)("div",{className:"flex-1 items-center text-md leading-7",children:[l&&"object"==typeof n&&(0,a.jsxs)(a.Fragment,{children:["[".concat(n.template_name,"]: "),(0,a.jsx)(A.Z,{sx:{color:"#1677ff"},component:"button",onClick:r,children:n.template_introduce||"More Details"})]}),"string"==typeof n&&(0,a.jsx)(L.Z,{options:I,children:n.replaceAll("\\n","\n")})]})]})},T=e=>{let{messages:t,onSubmit:l,paramsObj:r={},clearInitMessage:n}=e,o=(0,C.useSearchParams)(),i=o&&o.get("initMessage"),c=o&&o.get("spaceNameOriginal"),{currentDialogue:d,scene:u,model:x}=(0,s.useContext)(f.p),h="chat_dashboard"===u,[m,p]=(0,s.useState)(!1),[v,E]=(0,s.useState)(""),[A,P]=(0,s.useState)(!1),[D,L]=(0,s.useState)(),[M,U]=(0,s.useState)(t),[F,I]=(0,s.useState)(""),T=(0,s.useRef)(null),W=(0,s.useMemo)(()=>Object.entries(r).map(e=>{let[t,l]=e;return{key:t,value:l}}),[r]),B=(0,S.cI)(),V=async e=>{let{query:t}=e;try{p(!0),B.reset(),await l(t,{select_param:"chat_excel"===u?null==d?void 0:d.select_param:r[v]})}catch(e){}finally{p(!1)}},z=async()=>{try{var e;let t=new URLSearchParams(window.location.search),l=t.get("initMessage");t.delete("initMessage"),null===(e=window.history)||void 0===e||e.replaceState(null,"","?".concat(t.toString())),await V({query:l})}catch(e){console.log(e)}finally{null==n||n()}},G=e=>{let t=e;try{t=JSON.parse(e)}catch(e){console.log(e)}return t};return(0,s.useEffect)(()=>{T.current&&T.current.scrollTo(0,T.current.scrollHeight)},[null==t?void 0:t.length]),(0,s.useEffect)(()=>{i&&t.length<=0&&z()},[z,i,t.length]),(0,s.useEffect)(()=>{(null==W?void 0:W.length)&&E(c||W[0].value)},[W,null==W?void 0:W.length,c]),(0,s.useEffect)(()=>{if(h){let e=R().cloneDeep(t);e.forEach(e=>{(null==e?void 0:e.role)==="view"&&"string"==typeof(null==e?void 0:e.context)&&(e.context=G(null==e?void 0:e.context))}),U(e.filter(e=>["view","human"].includes(e.role)))}else U(t.filter(e=>["view","human"].includes(e.role)))},[h,t]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{ref:T,className:"flex flex-1 overflow-y-auto pb-8 w-full flex-col",children:(0,a.jsx)("div",{className:"flex items-center flex-1 flex-col text-sm leading-6 text-slate-900 dark:text-slate-300 sm:text-base sm:leading-7",children:null==M?void 0:M.map((e,t)=>(0,a.jsx)(J,{content:e,isChartChat:h,onLinkClick:()=>{P(!0),L(t),I(JSON.stringify(null==e?void 0:e.context,null,2))}},t))})}),(0,a.jsx)("div",{className:H()("relative after:absolute after:-top-8 after:h-8 after:w-full after:bg-gradient-to-t after:from-white after:to-transparent dark:after:from-[#212121]",{"cursor-not-allowed":"chat_excel"===u&&!(null==d?void 0:d.select_param)}),children:(0,a.jsxs)("form",{className:"flex flex-wrap w-full py-2 sm:pt-6 sm:pb-10",onSubmit:e=>{e.stopPropagation(),B.handleSubmit(V)(e)},children:[!!(null==W?void 0:W.length)&&(0,a.jsx)("div",{className:H()("flex flex-grow items-center h-12 mb-2",{"max-w-[6rem] sm:max-w-[12rem] mr-2":"chat_dashboard"!==u}),children:(0,a.jsx)(y.Z,{className:"h-full w-full",value:v,onChange:(e,t)=>{E(null!=t?t:"")},children:W.map(e=>(0,a.jsx)(w.Z,{value:e.value,children:e.key},e.key))})}),(0,a.jsx)(j.ZP,{disabled:"chat_excel"===u&&!(null==d?void 0:d.select_param),className:"flex-1 h-12 min-w-min",style:{minWidth:"min-content"},variant:"outlined",startDecorator:(0,q.A)(x||""),endDecorator:(0,a.jsx)(b.ZP,{type:"submit",children:m?(0,a.jsx)(_.Z,{}):(0,a.jsx)(g.Z,{})}),...B.register("query")})]})}),(0,a.jsx)(Z.Z,{open:A,onClose:()=>{P(!1)},children:(0,a.jsxs)(N.Z,{className:"w-1/2 h-[600px] flex items-center justify-center","aria-labelledby":"variant-modal-title","aria-describedby":"variant-modal-description",children:[(0,a.jsx)(O.Z,{className:"w-full h-[500px]",language:"json",value:F}),(0,a.jsx)(k.Z,{variant:"outlined",className:"w-full mt-2",onClick:()=>P(!1),children:"OK"})]})})]})},W=l(50489),B=l(45247),V=l(79716),z=l(39156);let G=()=>(0,a.jsxs)(r.Z,{className:"h-full w-full flex bg-transparent",children:[(0,a.jsx)(n.Z,{animation:"wave",variant:"text",level:"body2"}),(0,a.jsx)(n.Z,{animation:"wave",variant:"text",level:"body2"}),(0,a.jsx)(o.Z,{ratio:"21/9",className:"flex-1",sx:{["& .".concat(i.Z.content)]:{height:"100%"}},children:(0,a.jsx)(n.Z,{variant:"overlay",className:"h-full"})})]});var K=()=>{let[e,t]=(0,s.useState)(!1),[l,r]=(0,s.useState)(),{refreshDialogList:n,scene:o,chatId:i,model:x,setModel:h}=(0,s.useContext)(f.p),{data:m=[],run:p}=(0,u.Z)(async()=>{t(!0);let[,e]=await (0,W.Vx)((0,W.$i)(i));t(!1);let l=(e||[]).filter(e=>"view"===e.role).slice(-1)[0];return(null==l?void 0:l.model_name)&&h(l.model_name),null!=e?e:[]},{ready:!!i,refreshDeps:[i]}),{history:g,handleChatSubmit:y}=v({queryAgentURL:"/v1/chat/completions",queryBody:{conv_uid:i,chat_mode:o||"chat_normal",model_name:x},initHistory:m}),{data:w={}}=(0,u.Z)(async()=>{let[,e]=await (0,W.Vx)((0,W.vD)(o));return null!=e?e:{}},{ready:!!o,refreshDeps:[i,o]});return(0,s.useEffect)(()=>{if(g&&!(g.length<1))try{var e;let t=null==g?void 0:null===(e=g[g.length-1])||void 0===e?void 0:e.context,l=JSON.parse(t);r((null==l?void 0:l.template_name)==="report"?null==l?void 0:l.charts:void 0)}catch(e){r(void 0)}},[g]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(V.Z,{refreshHistory:p,modelChange:e=>{h(e)}}),(0,a.jsx)(B.Z,{visible:e}),(0,a.jsxs)("div",{className:"px-4 flex flex-1 overflow-hidden",children:[(0,a.jsx)(z.Z,{chartsData:l}),!l&&"chat_dashboard"===o&&(0,a.jsx)("div",{className:"w-3/4 p-6",children:(0,a.jsx)("div",{className:"flex flex-col gap-3 h-full",children:(0,a.jsxs)(c.Z,{container:!0,spacing:2,sx:{flexGrow:1},children:[(0,a.jsx)(c.Z,{xs:8,children:(0,a.jsx)(d.Z,{className:"h-full w-full",sx:{display:"flex",gap:2},children:(0,a.jsx)(G,{})})}),(0,a.jsx)(c.Z,{xs:4,children:(0,a.jsx)(G,{})}),(0,a.jsx)(c.Z,{xs:4,children:(0,a.jsx)(G,{})}),(0,a.jsx)(c.Z,{xs:8,children:(0,a.jsx)(G,{})})]})})}),(0,a.jsx)("div",{className:H()("flex flex-1 flex-col h-full px-8 w-full",{"w-1/3 pl-4 px-0 py-0":"chat_dashboard"===o}),children:(0,a.jsx)(T,{clearInitMessage:async()=>{await n()},messages:g,onSubmit:y,paramsObj:w})})]})]})}},45247:function(e,t,l){var a=l(85893),s=l(48699);t.Z=function(e){let{visible:t}=e;return t?(0,a.jsx)("div",{className:"absolute w-full h-full top-0 left-0 flex justify-center items-center z-10 bg-white dark:bg-black bg-opacity-50 dark:bg-opacity-50",children:(0,a.jsx)(s.Z,{variant:"plain"})}):null}}}]);